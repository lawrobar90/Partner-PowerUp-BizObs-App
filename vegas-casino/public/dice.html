<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynatrace Vegas - Neural Dice</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Tailwind Config -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'dt-purple': '#6C2C9C',
                        'dt-blue': '#00A1C9',
                        'dt-cyan': '#00D4FF',
                        'dt-green': '#73BE28',
                        'dt-orange': '#FFA86B',
                        'dt-yellow': '#FFD23F',
                        'dt-dark': '#151515',
                        'dt-darker': '#0A0A0A',
                        'dt-gray': '#2D2D2D',
                        'dt-light-gray': '#4A4A4A'
                    }
                }
            }
        }
    </script>
    
    <!-- External libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* Dice specific styles */
        .dice-bg {
            background: 
                radial-gradient(circle at 25% 35%, rgba(255, 168, 107, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 75% 65%, rgba(255, 210, 63, 0.1) 0%, transparent 50%),
                linear-gradient(135deg, #0A0A0A 0%, #151515 100%);
        }
        
        .dice-table {
            background: linear-gradient(145deg, #2D1B00, #1A1000);
            border: 3px solid #FFA86B;
            box-shadow: 
                0 0 30px rgba(255, 168, 107, 0.4),
                inset 0 0 20px rgba(255, 168, 107, 0.1);
        }
        
        .dice {
            width: 80px;
            height: 80px;
            background: linear-gradient(145deg, #fff, #e0e0e0);
            border: 2px solid #ccc;
            border-radius: 12px;
            position: relative;
            box-shadow: 
                0 8px 16px rgba(0, 0, 0, 0.3),
                inset 0 2px 4px rgba(255, 255, 255, 0.8);
            transition: all 0.3s ease;
        }
        
        .dice.rolling {
            animation: dice-roll 1s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            transform: scale(1.1);
        }
        
        @keyframes dice-roll {
            0% { transform: rotate(0deg) scale(1); }
            25% { transform: rotate(90deg) scale(1.1); }
            50% { transform: rotate(180deg) scale(1.2); }
            75% { transform: rotate(270deg) scale(1.1); }
            100% { transform: rotate(360deg) scale(1); }
        }
        
        .dice-dot {
            position: absolute;
            width: 12px;
            height: 12px;
            background: #333;
            border-radius: 50%;
            box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.3);
        }
        
        /* Dice face patterns */
        .dice-face-1 .dice-dot:nth-child(1) {
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        
        .dice-face-2 .dice-dot:nth-child(1) {
            top: 20%;
            left: 20%;
        }
        .dice-face-2 .dice-dot:nth-child(2) {
            bottom: 20%;
            right: 20%;
        }
        
        .dice-face-3 .dice-dot:nth-child(1) {
            top: 20%;
            left: 20%;
        }
        .dice-face-3 .dice-dot:nth-child(2) {
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        .dice-face-3 .dice-dot:nth-child(3) {
            bottom: 20%;
            right: 20%;
        }
        
        .dice-face-4 .dice-dot:nth-child(1) {
            top: 20%;
            left: 20%;
        }
        .dice-face-4 .dice-dot:nth-child(2) {
            top: 20%;
            right: 20%;
        }
        .dice-face-4 .dice-dot:nth-child(3) {
            bottom: 20%;
            left: 20%;
        }
        .dice-face-4 .dice-dot:nth-child(4) {
            bottom: 20%;
            right: 20%;
        }
        
        .dice-face-5 .dice-dot:nth-child(1) {
            top: 20%;
            left: 20%;
        }
        .dice-face-5 .dice-dot:nth-child(2) {
            top: 20%;
            right: 20%;
        }
        .dice-face-5 .dice-dot:nth-child(3) {
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        .dice-face-5 .dice-dot:nth-child(4) {
            bottom: 20%;
            left: 20%;
        }
        .dice-face-5 .dice-dot:nth-child(5) {
            bottom: 20%;
            right: 20%;
        }
        
        .dice-face-6 .dice-dot:nth-child(1) {
            top: 20%;
            left: 20%;
        }
        .dice-face-6 .dice-dot:nth-child(2) {
            top: 20%;
            right: 20%;
        }
        .dice-face-6 .dice-dot:nth-child(3) {
            top: 50%;
            left: 20%;
            transform: translateY(-50%);
        }
        .dice-face-6 .dice-dot:nth-child(4) {
            top: 50%;
            right: 20%;
            transform: translateY(-50%);
        }
        .dice-face-6 .dice-dot:nth-child(5) {
            bottom: 20%;
            left: 20%;
        }
        .dice-face-6 .dice-dot:nth-child(6) {
            bottom: 20%;
            right: 20%;
        }
        
        .bet-area {
            background: linear-gradient(145deg, rgba(255, 168, 107, 0.1), rgba(45, 45, 45, 0.8));
            border: 2px solid rgba(255, 168, 107, 0.3);
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .bet-area:hover {
            border-color: #FFA86B;
            background: linear-gradient(145deg, rgba(255, 168, 107, 0.2), rgba(45, 45, 45, 0.9));
            transform: translateY(-2px);
        }
        
        .bet-area.selected {
            border-color: #FFD23F;
            background: linear-gradient(145deg, rgba(255, 210, 63, 0.2), rgba(45, 45, 45, 0.95));
            box-shadow: 0 0 20px rgba(255, 210, 63, 0.4);
        }
        
        .probability-chart {
            background: rgba(21, 21, 21, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 168, 107, 0.3);
        }
        
        .sum-indicator {
            transition: all 0.5s ease;
            transform: scale(1);
        }
        
        .sum-indicator.highlight {
            transform: scale(1.2);
            background: linear-gradient(145deg, #FFD23F, #FFA86B) !important;
            box-shadow: 0 0 20px rgba(255, 210, 63, 0.8);
        }
    </style>
</head>
<body class="min-h-screen dice-bg text-white font-sans">
    
    <!-- Header -->
    <header class="bg-dt-dark/80 backdrop-blur-md border-b border-dt-orange/30">
        <div class="max-w-7xl mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <button onclick="window.location.href='lobby.html'" class="bg-dt-orange hover:bg-dt-orange/80 text-white px-4 py-2 rounded-lg font-semibold transition-colors flex items-center space-x-2">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd"/>
                        </svg>
                        <span>Back to Lobby</span>
                    </button>
                    <div>
                        <h1 class="text-xl font-bold text-dt-orange">Neural Dice</h1>
                        <p class="text-xs text-dt-light-gray">Probability Prediction Engine</p>
                    </div>
                </div>
                <div class="flex items-center space-x-6">
                    <div class="flex items-center space-x-4 text-sm">
                        <div>
                            <span class="text-dt-light-gray">Agent:</span>
                            <span id="agentName" class="font-mono text-white ml-1">Loading...</span>
                        </div>
                        <div>
                            <span class="text-dt-light-gray">Balance:</span>
                            <span id="balanceDisplay" class="font-mono text-dt-yellow font-semibold ml-1">$0</span>
                        </div>
                        <button onclick="addFunds()" class="bg-dt-green hover:bg-dt-green/80 text-white px-3 py-1 rounded text-xs font-semibold transition-colors">
                            Top Up
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </header>
    
    <!-- Main Game Area -->
    <main class="flex-1 py-8">
        <div class="max-w-7xl mx-auto px-6">
            <div class="grid lg:grid-cols-4 gap-8">
                
                <!-- Dice Game Table -->
                <div class="lg:col-span-3">
                    <div class="dice-table rounded-3xl p-8">
                        
                        <!-- Dice Area -->
                        <div class="text-center mb-8">
                            <h2 class="text-2xl font-bold text-dt-orange mb-6">Neural Dice Prediction</h2>
                            
                            <!-- Dice Display -->
                            <div class="flex justify-center space-x-8 mb-8">
                                <div class="text-center">
                                    <div id="dice1" class="dice dice-face-1 mx-auto mb-2">
                                        <div class="dice-dot"></div>
                                    </div>
                                    <div class="text-sm text-dt-light-gray">Die 1</div>
                                </div>
                                <div class="text-center">
                                    <div id="dice2" class="dice dice-face-1 mx-auto mb-2">
                                        <div class="dice-dot"></div>
                                    </div>
                                    <div class="text-sm text-dt-light-gray">Die 2</div>
                                </div>
                            </div>
                            
                            <!-- Sum Display -->
                            <div class="mb-6">
                                <div class="text-4xl font-bold text-dt-yellow mb-2" id="diceSum">2</div>
                                <div class="text-dt-light-gray">Total Sum</div>
                            </div>
                        </div>
                        
                        <!-- Betting Areas -->
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-4 mb-8">
                            <div class="bet-area rounded-xl p-4 text-center" data-bet="pass" onclick="placeBet('pass')">
                                <div class="font-bold text-lg text-dt-green">PASS LINE</div>
                                <div class="text-sm text-dt-light-gray">Win on 7 or 11</div>
                                <div class="text-xs text-dt-yellow">Payout: 2:1</div>
                            </div>
                            
                            <div class="bet-area rounded-xl p-4 text-center" data-bet="dont_pass" onclick="placeBet('dont_pass')">
                                <div class="font-bold text-lg text-red-400">DON'T PASS</div>
                                <div class="text-sm text-dt-light-gray">Win on 2 or 3</div>
                                <div class="text-xs text-dt-yellow">Payout: 2:1</div>
                            </div>
                            
                            <div class="bet-area rounded-xl p-4 text-center" data-bet="field" onclick="placeBet('field')">
                                <div class="font-bold text-lg text-dt-blue">FIELD</div>
                                <div class="text-sm text-dt-light-gray">2,3,4,9,10,11,12</div>
                                <div class="text-xs text-dt-yellow">Payout: 2:1</div>
                            </div>
                            
                            <div class="bet-area rounded-xl p-4 text-center" data-bet="snake_eyes" onclick="placeBet('snake_eyes')">
                                <div class="font-bold text-lg text-dt-purple">SNAKE EYES</div>
                                <div class="text-sm text-dt-light-gray">Double 1s</div>
                                <div class="text-xs text-dt-yellow">Payout: 30:1</div>
                            </div>
                            
                            <div class="bet-area rounded-xl p-4 text-center" data-bet="boxcars" onclick="placeBet('boxcars')">
                                <div class="font-bold text-lg text-dt-purple">BOXCARS</div>
                                <div class="text-sm text-dt-light-gray">Double 6s</div>
                                <div class="text-xs text-dt-yellow">Payout: 30:1</div>
                            </div>
                            
                            <div class="bet-area rounded-xl p-4 text-center" data-bet="seven_out" onclick="placeBet('seven_out')">
                                <div class="font-bold text-lg text-dt-cyan">SEVEN OUT</div>
                                <div class="text-sm text-dt-light-gray">Sum equals 7</div>
                                <div class="text-xs text-dt-yellow">Payout: 4:1</div>
                            </div>
                        </div>
                        
                        <!-- Control Panel -->
                        <div class="bg-dt-gray/50 rounded-xl p-6 backdrop-blur-sm border border-dt-orange/20">
                            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                                <div>
                                    <label class="block text-dt-orange font-semibold mb-2">Bet Amount:</label>
                                    <select id="betAmount" class="w-full bg-dt-dark border border-dt-orange/30 rounded-lg px-4 py-2 text-white focus:outline-none focus:border-dt-orange">
                                        <option value="5">$5</option>
                                        <option value="10" selected>$10</option>
                                        <option value="25">$25</option>
                                        <option value="50">$50</option>
                                    </select>
                                </div>
                                
                                <div>
                                    <label class="block text-dt-orange font-semibold mb-2">Active Bet:</label>
                                    <div id="activeBetDisplay" class="bg-dt-dark border border-dt-orange/30 rounded-lg px-4 py-2 text-dt-light-gray">
                                        None
                                    </div>
                                </div>
                                
                                <div>
                                    <label class="block text-dt-orange font-semibold mb-2">Total Risk:</label>
                                    <div id="totalBetDisplay" class="bg-dt-dark border border-dt-orange/30 rounded-lg px-4 py-2 text-dt-yellow font-mono">
                                        $0
                                    </div>
                                </div>
                                
                                <div class="space-y-2">
                                    <button onclick="clearBets()" class="w-full bg-dt-gray hover:bg-dt-light-gray text-white py-2 px-4 rounded-lg font-semibold transition-colors">
                                        Clear
                                    </button>
                                    <button onclick="rollDice()" id="rollButton" class="w-full bg-gradient-to-r from-dt-orange to-dt-yellow hover:from-dt-yellow hover:to-dt-orange text-white py-2 px-4 rounded-lg font-bold transition-all transform hover:scale-105 active:scale-95">
                                        ROLL DICE
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Result Display -->
                        <div id="resultDisplay" class="text-center mt-6 text-xl font-bold min-h-[2rem]"></div>
                    </div>
                </div>
                
                <!-- Side Panel -->
                <div class="space-y-6">
                    
                    <!-- Probability Chart -->
                    <div class="probability-chart rounded-xl p-4">
                        <h3 class="text-dt-orange font-semibold mb-4">Sum Probabilities</h3>
                        <div class="grid grid-cols-3 gap-2 text-xs">
                            <div class="sum-indicator bg-dt-gray/50 p-2 rounded text-center">
                                <div class="font-bold">2</div>
                                <div class="text-dt-light-gray">2.8%</div>
                            </div>
                            <div class="sum-indicator bg-dt-gray/50 p-2 rounded text-center">
                                <div class="font-bold">3</div>
                                <div class="text-dt-light-gray">5.6%</div>
                            </div>
                            <div class="sum-indicator bg-dt-gray/50 p-2 rounded text-center">
                                <div class="font-bold">4</div>
                                <div class="text-dt-light-gray">8.3%</div>
                            </div>
                            <div class="sum-indicator bg-dt-gray/50 p-2 rounded text-center">
                                <div class="font-bold">5</div>
                                <div class="text-dt-light-gray">11.1%</div>
                            </div>
                            <div class="sum-indicator bg-dt-gray/50 p-2 rounded text-center">
                                <div class="font-bold">6</div>
                                <div class="text-dt-light-gray">13.9%</div>
                            </div>
                            <div class="sum-indicator bg-dt-orange/50 p-2 rounded text-center">
                                <div class="font-bold">7</div>
                                <div class="text-white">16.7%</div>
                            </div>
                            <div class="sum-indicator bg-dt-gray/50 p-2 rounded text-center">
                                <div class="font-bold">8</div>
                                <div class="text-dt-light-gray">13.9%</div>
                            </div>
                            <div class="sum-indicator bg-dt-gray/50 p-2 rounded text-center">
                                <div class="font-bold">9</div>
                                <div class="text-dt-light-gray">11.1%</div>
                            </div>
                            <div class="sum-indicator bg-dt-gray/50 p-2 rounded text-center">
                                <div class="font-bold">10</div>
                                <div class="text-dt-light-gray">8.3%</div>
                            </div>
                            <div class="sum-indicator bg-dt-gray/50 p-2 rounded text-center">
                                <div class="font-bold">11</div>
                                <div class="text-dt-light-gray">5.6%</div>
                            </div>
                            <div class="sum-indicator bg-dt-gray/50 p-2 rounded text-center">
                                <div class="font-bold">12</div>
                                <div class="text-dt-light-gray">2.8%</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Game Stats -->
                    <div class="probability-chart rounded-xl p-4">
                        <h3 class="text-dt-orange font-semibold mb-3">Game Stats</h3>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span class="text-dt-light-gray">Rolls:</span>
                                <span id="totalRolls" class="text-dt-cyan font-mono">0</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-dt-light-gray">Wins:</span>
                                <span id="totalWins" class="text-dt-green font-mono">0</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-dt-light-gray">Win Rate:</span>
                                <span id="winRate" class="text-dt-yellow font-mono">0%</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-dt-light-gray">Total Won:</span>
                                <span id="totalWon" class="text-dt-green font-mono">$0</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Recent Rolls -->
                    <div class="probability-chart rounded-xl p-4">
                        <h3 class="text-dt-orange font-semibold mb-3">Recent Rolls</h3>
                        <div id="recentRolls" class="space-y-2 text-xs max-h-32 overflow-y-auto">
                            <div class="text-dt-light-gray text-center">No rolls yet</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
    // Initialize Socket.IO
    const socket = io();
        
        // Game state
        let isRolling = false;
        let currentBet = null;
        let gameStats = {
            totalRolls: 0,
            totalWins: 0,
            totalWon: 0,
            recentRolls: []
        };
        
        // Dice face patterns
        const diceFaces = {
            1: 1, 2: 2, 3: 3, 4: 4, 5: 5, 6: 6
        };
        
        function updateDiceFace(diceId, value) {
            const dice = document.getElementById(diceId);
            dice.className = `dice dice-face-${value}`;
            dice.innerHTML = '';
            
            // Add dots based on value
            for (let i = 0; i < value; i++) {
                const dot = document.createElement('div');
                dot.className = 'dice-dot';
                dice.appendChild(dot);
            }
        }
        
        function placeBet(betType) {
            if (isRolling) return;
            
            // Clear previous selection
            document.querySelectorAll('.bet-area').forEach(area => {
                area.classList.remove('selected');
            });
            
            // Select new bet
            const betArea = document.querySelector(`[data-bet="${betType}"]`);
            if (betArea) {
                betArea.classList.add('selected');
            }
            
            currentBet = betType;
            
            const betAmount = parseInt(document.getElementById('betAmount').value);
            const betNames = {
                pass: 'Pass Line',
                dont_pass: "Don't Pass",
                field: 'Field',
                snake_eyes: 'Snake Eyes',
                boxcars: 'Boxcars',
                seven_out: 'Seven Out'
            };
            
            document.getElementById('activeBetDisplay').textContent = betNames[betType] || betType;
            document.getElementById('totalBetDisplay').textContent = `$${betAmount}`;
        }
        
        function clearBets() {
            currentBet = null;
            document.querySelectorAll('.bet-area').forEach(area => {
                area.classList.remove('selected');
            });
            document.getElementById('activeBetDisplay').textContent = 'None';
            document.getElementById('totalBetDisplay').textContent = '$0';
        }
        
        async function rollDice() {
            if (isRolling || !currentBet) {
                if (!currentBet) {
                    showNotification('Please place a bet first!', 'error');
                }
                return;
            }
            
            const betAmount = parseInt(document.getElementById('betAmount').value);
            // balance check will be enforced server-side; optional client check from last known display
            const displayBalance = parseInt((document.getElementById('balanceDisplay').textContent || '0').replace(/[^0-9]/g, '')) || 0;
            if (displayBalance < betAmount) {
                showNotification('Insufficient balance!', 'error');
                return;
            }
            
            // Start rolling animation
            isRolling = true;
            document.getElementById('rollButton').disabled = true;
            document.getElementById('rollButton').textContent = 'ROLLING...';
            // Deduct stake immediately (visual)
            const preRollBalance = parseInt((document.getElementById('balanceDisplay').textContent || '0').replace(/[^0-9]/g, '')) || 0;
            document.getElementById('balanceDisplay').textContent = `$${Math.max(0, preRollBalance - betAmount)}`;
            
            // Animate dice rolling
            const dice1 = document.getElementById('dice1');
            const dice2 = document.getElementById('dice2');
            
            dice1.classList.add('rolling');
            dice2.classList.add('rolling');
            
            document.getElementById('resultDisplay').innerHTML = `
                <div class="text-dt-orange animate-pulse">
                    🎲 Rolling dice... 🎲
                </div>
            `;
            
            try {
                // Make API call (server handles balance debit/credit and returns newBalance)
                const response = await fetch('/api/dice/roll', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        Game: 'Vegas Dice',
                        BetAmount: betAmount,
                        Username: localStorage.getItem('vegas.username') || localStorage.getItem('vegasUser') || 'Anonymous',
                        WinFlag: null,
                        WinningAmount: 0,
                        LossAmount: 0,
                        Balance: parseInt(localStorage.getItem('vegasBalance') || '0'),
                        Timestamp: new Date().toISOString(),
                        Action: 'Roll',
                        Device: 'Browser-UI',
                        CorrelationId: `sim_${Date.now()}_${Math.floor(Math.random()*1e9)}`,
                        ResultIcons: [],
                        Status: 'Started',
                        ErrorType: null,
                        ErrorMessage: null,
                        StatusCode: 0,
                        // game-specific
                        BetType: currentBet
                    })
                });
                
                const data = await response.json();
                // Hold server newBalance until roll finishes
                const pendingNewBalance = (typeof data.newBalance === 'number') ? data.newBalance : null;
                
                // Wait for rolling animation
                setTimeout(() => {
                    // Stop rolling animation
                    dice1.classList.remove('rolling');
                    dice2.classList.remove('rolling');
                    
                    // Update dice faces
                    updateDiceFace('dice1', data.dice1);
                    updateDiceFace('dice2', data.dice2);
                    
                    // Update sum display
                    document.getElementById('diceSum').textContent = data.sum;
                    
                    // Highlight sum in probability chart
                    highlightSum(data.sum);
                    
                    // Show result
                    showResult(data, betAmount);
                    updateGameStats(data, betAmount);
                    // Emit Completed BizEvent
                    try {
                        const completedEvent = {
                            Game: 'Vegas Dice',
                            BetAmount: betAmount,
                            Username: localStorage.getItem('vegas.username') || localStorage.getItem('vegasUser') || 'Anonymous',
                            WinFlag: data.win ? 1 : 0,
                            WinningAmount: data.payout || 0,
                            LossAmount: data.win ? 0 : betAmount,
                            Balance: parseInt((document.getElementById('balanceDisplay').textContent || '0').replace(/[^0-9]/g,'')) || 0,
                            Timestamp: new Date().toISOString(),
                            Action: 'RollCompleted',
                            Device: 'Browser-UI',
                            CorrelationId: data.correlationId || `sim_${Date.now()}`,
                            ResultIcons: [String(data.dice1), String(data.dice2)],
                            Status: 'Completed',
                            ErrorType: null,
                            ErrorMessage: null,
                            StatusCode: 200
                        };
                        fetch('/api/bizevent', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(completedEvent) });
                    } catch {}
                    
                    // Apply final balance now
                    if (pendingNewBalance !== null) {
                        localStorage.setItem('vegasBalance', String(pendingNewBalance));
                        document.getElementById('balanceDisplay').textContent = `$${pendingNewBalance}`;
                    }
                    // Reset for next roll
                    setTimeout(() => {
                        clearBets();
                        isRolling = false;
                        document.getElementById('rollButton').disabled = false;
                        document.getElementById('rollButton').textContent = 'ROLL DICE';
                    }, 3000);
                }, 1000);
                
            } catch (error) {
                console.error('Roll error:', error);
                showNotification('Roll failed! Try again.', 'error');
                // Refund stake on error
                document.getElementById('balanceDisplay').textContent = `$${preRollBalance}`;
                
                dice1.classList.remove('rolling');
                dice2.classList.remove('rolling');
                
                isRolling = false;
                document.getElementById('rollButton').disabled = false;
                document.getElementById('rollButton').textContent = 'ROLL DICE';
            }
        }
        
        function highlightSum(sum) {
            // Remove previous highlights
            document.querySelectorAll('.sum-indicator').forEach(indicator => {
                indicator.classList.remove('highlight');
            });
            
            // Highlight current sum
            const sumIndicators = document.querySelectorAll('.sum-indicator');
            const targetIndicator = Array.from(sumIndicators).find(indicator => {
                const value = parseInt(indicator.querySelector('div').textContent);
                return value === sum;
            });
            
            if (targetIndicator) {
                targetIndicator.classList.add('highlight');
                
                setTimeout(() => {
                    targetIndicator.classList.remove('highlight');
                }, 3000);
            }
        }
        
        function showResult(data, betAmount) {
            const resultDiv = document.getElementById('resultDisplay');
            
            if (data.win) {
                resultDiv.innerHTML = `
                    <div class="text-dt-green">
                        🎉 WIN! Rolled ${data.dice1} and ${data.dice2} (Sum: ${data.sum})
                        <br>
                        <span class="text-2xl">+$${data.payout}</span>
                    </div>
                `;
                
                // Show payout animation
                const payoutText = document.createElement('div');
                payoutText.className = 'fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-6xl font-bold text-dt-yellow z-50 animate-bounce';
                payoutText.textContent = `+$${data.payout}`;
                document.body.appendChild(payoutText);
                
                setTimeout(() => {
                    payoutText.remove();
                }, 2000);
                
            } else {
                resultDiv.innerHTML = `
                    <div class="text-dt-light-gray">
                        😔 No win this time. Rolled ${data.dice1} and ${data.dice2} (Sum: ${data.sum})
                        <br>
                        Better luck next roll!
                    </div>
                `;
            }
            
            // Clear result after delay
            setTimeout(() => {
                resultDiv.innerHTML = '';
            }, 5000);
        }
        
        function updateGameStats(data, betAmount) {
            gameStats.totalRolls++;
            if (data.win) {
                gameStats.totalWins++;
                gameStats.totalWon += data.payout;
            }
            
            // Add to recent rolls
            gameStats.recentRolls.unshift({
                dice1: data.dice1,
                dice2: data.dice2,
                sum: data.sum,
                bet: currentBet,
                betAmount: betAmount,
                win: data.win,
                payout: data.payout || 0,
                timestamp: Date.now()
            });
            
            // Keep only last 10 rolls
            if (gameStats.recentRolls.length > 10) {
                gameStats.recentRolls = gameStats.recentRolls.slice(0, 10);
            }
            
            updateStatsDisplay();
            updateRecentRollsDisplay();
            
            // Emit game action
            socket.emit('game-action', {
                game: 'dice',
                action: 'roll',
                betAmount: betAmount,
                win: data.win,
                winAmount: data.payout || 0,
                result: [data.dice1, data.dice2]
            });
        }
        
        function updateStatsDisplay() {
            document.getElementById('totalRolls').textContent = gameStats.totalRolls;
            document.getElementById('totalWins').textContent = gameStats.totalWins;
            document.getElementById('totalWon').textContent = `$${gameStats.totalWon}`;
            
            const winRate = gameStats.totalRolls > 0 ? 
                ((gameStats.totalWins / gameStats.totalRolls) * 100).toFixed(1) : 0;
            document.getElementById('winRate').textContent = `${winRate}%`;
        }
        
        function updateRecentRollsDisplay() {
            const container = document.getElementById('recentRolls');
            container.innerHTML = '';
            
            if (gameStats.recentRolls.length === 0) {
                container.innerHTML = '<div class="text-dt-light-gray text-center">No rolls yet</div>';
                return;
            }
            
            gameStats.recentRolls.forEach(roll => {
                const rollDiv = document.createElement('div');
                rollDiv.className = 'flex justify-between items-center p-2 bg-dt-darker rounded border border-dt-gray/30';
                rollDiv.innerHTML = `
                    <div class="flex items-center space-x-2">
                        <div class="text-xs bg-dt-gray px-2 py-1 rounded">${roll.dice1}</div>
                        <div class="text-xs bg-dt-gray px-2 py-1 rounded">${roll.dice2}</div>
                        <div class="text-xs text-dt-light-gray">= ${roll.sum}</div>
                    </div>
                    <div class="text-right text-xs">
                        <div class="text-dt-light-gray">$${roll.betAmount}</div>
                        <div class="${roll.win ? 'text-dt-green' : 'text-dt-light-gray'}">
                            ${roll.win ? `+$${roll.payout}` : '-'}
                        </div>
                    </div>
                `;
                container.appendChild(rollDiv);
            });
        }
        
        async function addFunds() {
            const username = localStorage.getItem('vegas.username') || localStorage.getItem('vegasUser') || 'Anonymous';
            try {
                const resp = await fetch('/api/user/topup', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ Username: username, Amount: 500 })
                });
                const data = await resp.json();
                if (typeof data.balance === 'number') {
                    localStorage.setItem('vegasBalance', String(data.balance));
                    updateBalanceDisplay();
                    showNotification('💰 $500 added to your balance!', 'success');
                } else {
                    showNotification('Top-up failed to persist.', 'error');
                }
            } catch (e) {
                showNotification('Top-up request failed.', 'error');
            }
        }
        
        function updateBalance(change) {
            const currentBalance = parseInt(localStorage.getItem('vegasBalance') || '0');
            const newBalance = Math.max(0, currentBalance + change);
            localStorage.setItem('vegasBalance', newBalance);
            updateBalanceDisplay();
        }
        
        function updateBalanceDisplay() {
            const balance = localStorage.getItem('vegasBalance') || '0';
            document.getElementById('balanceDisplay').textContent = `$${balance}`;
        }
        
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `fixed top-6 right-6 z-50 p-4 rounded-lg shadow-lg ${
                type === 'success' ? 'bg-dt-green text-white' : 
                type === 'error' ? 'bg-red-500 text-white' : 
                'bg-dt-blue text-white'
            }`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            // Animate in
            gsap.from(notification, {
                duration: 0.3,
                x: 100,
                opacity: 0,
                ease: "back.out(1.7)"
            });
            
            // Auto remove
            setTimeout(() => {
                gsap.to(notification, {
                    duration: 0.3,
                    x: 100,
                    opacity: 0,
                    ease: "back.in(1.7)",
                    onComplete: () => notification.remove()
                });
            }, 3000);
        }
        
        // Initialize page
        document.addEventListener('DOMContentLoaded', async function() {
            const username = localStorage.getItem('vegas.username') || localStorage.getItem('vegasUser') || 'Agent';
            document.getElementById('agentName').textContent = username;
            
            // Sync balance with server
            try {
                const resp = await fetch('/api/user/init', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ Username: username })
                });
                const u = await resp.json();
                if (typeof u.balance === 'number') {
                    localStorage.setItem('vegasBalance', String(u.balance));
                    document.getElementById('balanceDisplay').textContent = `$${u.balance}`;
                } else {
                    updateBalanceDisplay();
                }
            } catch (e) {
                updateBalanceDisplay();
            }
            
            // Initialize dice with random values
            updateDiceFace('dice1', Math.floor(Math.random() * 6) + 1);
            updateDiceFace('dice2', Math.floor(Math.random() * 6) + 1);
            
            // Animate page entrance
            gsap.from('.dice-table', {
                duration: 1,
                scale: 0.9,
                opacity: 0,
                ease: "back.out(1.7)"
            });
            
            gsap.from('.dice', {
                duration: 0.8,
                y: -50,
                rotation: 180,
                opacity: 0,
                stagger: 0.2,
                ease: "bounce.out",
                delay: 0.5
            });
        });
        
        // Socket event handlers
        socket.on('connect', () => {
            console.log('🔌 Connected to dice game');
        });
    </script>
</body>
</html>