<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynatrace Vegas - Quantum Blackjack</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Tailwind Config -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'dt-purple': '#6C2C9C',
                        'dt-blue': '#00A1C9',
                        'dt-cyan': '#00D4FF',
                        'dt-green': '#73BE28',
                        'dt-orange': '#FFA86B',
                        'dt-yellow': '#FFD23F',
                        'dt-dark': '#151515',
                        'dt-darker': '#0A0A0A',
                        'dt-gray': '#2D2D2D',
                        'dt-light-gray': '#4A4A4A'
                    }
                }
            }
        }
    </script>
    
    <!-- External libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* Blackjack specific styles */
        .blackjack-bg {
            background: 
                radial-gradient(circle at 25% 35%, rgba(108, 44, 156, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 75% 65%, rgba(0, 212, 255, 0.1) 0%, transparent 50%),
                linear-gradient(135deg, #0A0A0A 0%, #151515 100%);
        }
        
        .blackjack-table {
            background: linear-gradient(145deg, #003300, #001100);
            border: 3px solid #73BE28;
            box-shadow: 
                0 0 30px rgba(115, 190, 40, 0.4),
                inset 0 0 20px rgba(115, 190, 40, 0.1);
        }
        
        .card {
            width: 80px;
            height: 120px;
            border-radius: 12px;
            position: relative;
            background: linear-gradient(145deg, #ffffff, #f0f0f0);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            font-weight: bold;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 6px;
            margin: 2px;
        }
        
        .card.red {
            color: #dc2626;
        }
        
        .card.black {
            color: #000000;
        }
        
        .card-back {
            background: linear-gradient(145deg, #6C2C9C, #4A1A6E);
            color: #ffffff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }
        
        .card.dealing {
            animation: card-deal 0.8s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }
        
        @keyframes card-deal {
            0% {
                transform: translateY(-100px) rotate(180deg);
                opacity: 0;
            }
            60% {
                transform: translateY(10px) rotate(10deg);
                opacity: 0.8;
            }
            100% {
                transform: translateY(0) rotate(0deg);
                opacity: 1;
            }
        }
        
        .card.flipping {
            animation: card-flip 0.6s ease-in-out;
        }
        
        @keyframes card-flip {
            0% { transform: rotateY(0deg); }
            50% { transform: rotateY(90deg); }
            100% { transform: rotateY(0deg); }
        }
        
        .hand-area {
            min-height: 140px;
            padding: 20px;
            border: 2px dashed rgba(115, 190, 40, 0.3);
            border-radius: 16px;
            background: rgba(115, 190, 40, 0.05);
            transition: all 0.3s ease;
        }
        
        .hand-area.active {
            border-color: #73BE28;
            background: rgba(115, 190, 40, 0.15);
            box-shadow: 0 0 20px rgba(115, 190, 40, 0.3);
        }
        
        .chip {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            position: relative;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 12px;
            border: 3px solid;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.8);
        }
        
        .chip-5 {
            background: linear-gradient(145deg, #dc2626, #991b1b);
            border-color: #7f1d1d;
            color: white;
        }
        
        .chip-10 {
            background: linear-gradient(145deg, #2563eb, #1d4ed8);
            border-color: #1e40af;
            color: white;
        }
        
        .chip-25 {
            background: linear-gradient(145deg, #16a34a, #15803d);
            border-color: #166534;
            color: white;
        }
        
        .chip-50 {
            background: linear-gradient(145deg, #7c3aed, #6d28d9);
            border-color: #5b21b6;
            color: white;
        }
        
        .chip-100 {
            background: linear-gradient(145deg, #000000, #404040);
            border-color: #262626;
            color: white;
        }
        
        .chip:hover {
            transform: scale(1.1) translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.4);
        }
        
        .action-button {
            background: linear-gradient(145deg, rgba(115, 190, 40, 0.8), rgba(115, 190, 40, 0.6));
            border: 2px solid #73BE28;
            border-radius: 12px;
            padding: 12px 24px;
            font-weight: bold;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            font-size: 14px;
            letter-spacing: 0.5px;
        }
        
        .action-button:hover:not(:disabled) {
            background: linear-gradient(145deg, #73BE28, rgba(115, 190, 40, 0.8));
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(115, 190, 40, 0.4);
        }
        
        .action-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }
        
        .score-display {
            background: linear-gradient(145deg, rgba(21, 21, 21, 0.9), rgba(45, 45, 45, 0.8));
            border: 2px solid rgba(115, 190, 40, 0.3);
            border-radius: 12px;
            padding: 16px;
            text-align: center;
        }
        
        .score-display.bust {
            border-color: #dc2626;
            background: linear-gradient(145deg, rgba(220, 38, 38, 0.2), rgba(45, 45, 45, 0.8));
        }
        
        .score-display.blackjack {
            border-color: #FFD23F;
            background: linear-gradient(145deg, rgba(255, 210, 63, 0.2), rgba(45, 45, 45, 0.8));
            animation: pulse-gold 2s infinite;
        }
        
        @keyframes pulse-gold {
            0%, 100% { box-shadow: 0 0 0 rgba(255, 210, 63, 0.4); }
            50% { box-shadow: 0 0 20px rgba(255, 210, 63, 0.8); }
        }
        
        .betting-area {
            background: linear-gradient(145deg, rgba(45, 45, 45, 0.8), rgba(21, 21, 21, 0.9));
            border: 2px solid rgba(115, 190, 40, 0.3);
            border-radius: 16px;
            padding: 20px;
        }
        
        .strategy-hint {
            background: rgba(108, 44, 156, 0.1);
            border: 1px solid rgba(108, 44, 156, 0.3);
            border-radius: 8px;
            padding: 8px 12px;
            font-size: 12px;
            color: #d8b4fe;
        }
        
        .game-status {
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: bold;
        }
    </style>
</head>
<body class="min-h-screen blackjack-bg text-white font-sans">
    
    <!-- Header -->
    <header class="bg-dt-dark/80 backdrop-blur-md border-b border-dt-green/30">
        <div class="max-w-7xl mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <button onclick="window.location.href='lobby.html'" class="bg-dt-green hover:bg-dt-green/80 text-white px-4 py-2 rounded-lg font-semibold transition-colors flex items-center space-x-2">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd"/>
                        </svg>
                        <span>Back to Lobby</span>
                    </button>
                    <div>
                        <h1 class="text-xl font-bold text-dt-green">Quantum Blackjack</h1>
                        <p class="text-xs text-dt-light-gray">Neural Strategy Engine</p>
                    </div>
                </div>
                <div class="flex items-center space-x-6">
                    <div class="flex items-center space-x-4 text-sm">
                        <div>
                            <span class="text-dt-light-gray">Agent:</span>
                            <span id="agentName" class="font-mono text-white ml-1">Loading...</span>
                        </div>
                        <div>
                            <span class="text-dt-light-gray">Balance:</span>
                            <span id="balanceDisplay" class="font-mono text-dt-yellow font-semibold ml-1">$0</span>
                        </div>
                        <button onclick="addFunds()" class="bg-dt-green hover:bg-dt-green/80 text-white px-3 py-1 rounded text-xs font-semibold transition-colors">
                            Top Up
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </header>
    
    <!-- Main Game Area -->
    <main class="flex-1 py-8">
        <div class="max-w-7xl mx-auto px-6">
            <div class="grid lg:grid-cols-4 gap-8">
                
                <!-- Blackjack Table -->
                <div class="lg:col-span-3">
                    <div class="blackjack-table rounded-3xl p-8">
                        
                        <!-- Dealer Section -->
                        <div class="mb-8">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-xl font-bold text-dt-green">Dealer</h2>
                                <div class="score-display" id="dealerScoreDisplay">
                                    <div class="text-2xl font-bold text-dt-green" id="dealerScore">0</div>
                                    <div class="text-xs text-dt-light-gray">Score</div>
                                </div>
                            </div>
                            <div class="hand-area" id="dealerHand">
                                <div class="flex flex-wrap justify-center gap-2" id="dealerCards">
                                    <!-- Dealer cards will be added here -->
                                </div>
                            </div>
                        </div>
                        
                        <!-- Game Status -->
                        <div class="game-status mb-8" id="gameStatus">
                            <span class="text-dt-cyan">Welcome to Quantum Blackjack! Place your bet to start.</span>
                        </div>
                        
                        <!-- Player Section -->
                        <div class="mb-8">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-xl font-bold text-dt-cyan">Player</h2>
                                <div class="score-display" id="playerScoreDisplay">
                                    <div class="text-2xl font-bold text-dt-cyan" id="playerScore">0</div>
                                    <div class="text-xs text-dt-light-gray">Score</div>
                                </div>
                            </div>
                            <div class="hand-area" id="playerHand">
                                <div class="flex flex-wrap justify-center gap-2" id="playerCards">
                                    <!-- Player cards will be added here -->
                                </div>
                            </div>
                        </div>
                        
                        <!-- Control Panel -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            
                            <!-- Betting Area -->
                            <div class="betting-area">
                                <h3 class="text-dt-green font-semibold mb-4">Betting Chips</h3>
                                <div class="flex justify-center space-x-4 mb-4">
                                    <div class="chip chip-5" onclick="setBet(5)">$5</div>
                                    <div class="chip chip-10" onclick="setBet(10)">$10</div>
                                    <div class="chip chip-25" onclick="setBet(25)">$25</div>
                                    <div class="chip chip-50" onclick="setBet(50)">$50</div>
                                    <div class="chip chip-100" onclick="setBet(100)">$100</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-dt-light-gray mb-2">Current Bet:</div>
                                    <div class="text-2xl font-bold text-dt-yellow" id="currentBet">$0</div>
                                </div>
                            </div>
                            
                            <!-- Action Buttons -->
                            <div class="betting-area">
                                <h3 class="text-dt-green font-semibold mb-4">Game Actions</h3>
                                <div class="grid grid-cols-2 gap-3">
                                    <button class="action-button" id="dealButton" onclick="startNewHand()">
                                        Deal Cards
                                    </button>
                                    <button class="action-button" id="hitButton" onclick="playerHit()" disabled>
                                        Hit
                                    </button>
                                    <button class="action-button" id="standButton" onclick="playerStand()" disabled>
                                        Stand
                                    </button>
                                    <button class="action-button" id="doubleButton" onclick="playerDouble()" disabled>
                                        Double Down
                                    </button>
                                </div>
                                <button class="action-button w-full mt-3" id="clearButton" onclick="clearBet()">
                                    Clear Bet
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Side Panel -->
                <div class="space-y-6">
                    
                    <!-- Strategy Hints -->
                    <div class="bg-dt-gray/50 rounded-xl p-4 backdrop-blur-sm border border-dt-purple/30">
                        <h3 class="text-dt-purple font-semibold mb-3">Strategy Advisor</h3>
                        <div id="strategyHint" class="strategy-hint">
                            Place a bet to receive AI-powered strategy recommendations.
                        </div>
                    </div>
                    
                    <!-- Game Statistics -->
                    <div class="bg-dt-gray/50 rounded-xl p-4 backdrop-blur-sm border border-dt-green/30">
                        <h3 class="text-dt-green font-semibold mb-3">Session Stats</h3>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span class="text-dt-light-gray">Hands:</span>
                                <span id="totalHands" class="text-dt-cyan font-mono">0</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-dt-light-gray">Wins:</span>
                                <span id="totalWins" class="text-dt-green font-mono">0</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-dt-light-gray">Blackjacks:</span>
                                <span id="totalBlackjacks" class="text-dt-yellow font-mono">0</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-dt-light-gray">Win Rate:</span>
                                <span id="winRate" class="text-dt-cyan font-mono">0%</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-dt-light-gray">Net Profit:</span>
                                <span id="netProfit" class="font-mono">$0</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Card Count Tracker -->
                    <div class="bg-dt-gray/50 rounded-xl p-4 backdrop-blur-sm border border-dt-blue/30">
                        <h3 class="text-dt-blue font-semibold mb-3">Deck Analysis</h3>
                        <div class="space-y-2 text-xs">
                            <div class="flex justify-between">
                                <span class="text-dt-light-gray">Cards Dealt:</span>
                                <span id="cardsDealt" class="text-dt-blue font-mono">0/52</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-dt-light-gray">High Cards Left:</span>
                                <span id="highCards" class="text-dt-orange font-mono">16</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-dt-light-gray">Low Cards Left:</span>
                                <span id="lowCards" class="text-dt-cyan font-mono">20</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-dt-light-gray">Running Count:</span>
                                <span id="runningCount" class="text-dt-yellow font-mono">0</span>
                            </div>
                        </div>
                        <div class="mt-3 p-2 bg-dt-darker rounded text-center">
                            <div class="text-xs text-dt-light-gray mb-1">Deck Penetration</div>
                            <div class="bg-dt-gray rounded-full h-2">
                                <div id="deckPenetration" class="bg-dt-blue h-2 rounded-full transition-all duration-500" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Recent Hands -->
                    <div class="bg-dt-gray/50 rounded-xl p-4 backdrop-blur-sm border border-dt-cyan/30">
                        <h3 class="text-dt-cyan font-semibold mb-3">Recent Hands</h3>
                        <div id="recentHands" class="space-y-2 text-xs max-h-32 overflow-y-auto">
                            <div class="text-dt-light-gray text-center">No hands played yet</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // Initialize Socket.IO
        const socket = io();
        
        // Game state
        let gameState = 'waiting'; // waiting, playing, dealer_turn, finished
        let playerHand = [];
        let dealerHand = [];
        let currentBet = 0;
        let gameStats = {
            totalHands: 0,
            totalWins: 0,
            totalBlackjacks: 0,
            totalPushes: 0,
            netProfit: 0,
            recentHands: []
        };
        let deckStats = {
            cardsDealt: 0,
            highCards: 16, // 10, J, Q, K, A
            lowCards: 20,  // 2-6
            runningCount: 0
        };
        
        function setBet(amount) {
            if (gameState !== 'waiting') return;
            
            const currentBalance = parseInt((document.getElementById('balanceDisplay').textContent || '0').replace(/[^0-9]/g, '')) || 0;
            if (currentBalance < amount) {
                showNotification('Insufficient balance!', 'error');
                return;
            }
            
            currentBet = amount;
            document.getElementById('currentBet').textContent = `$${amount}`;
            
            // Animate chip selection
            document.querySelectorAll('.chip').forEach(chip => {
                chip.style.transform = 'scale(1)';
                chip.style.boxShadow = '';
            });
            
            event.target.style.transform = 'scale(1.2)';
            event.target.style.boxShadow = '0 0 20px rgba(115, 190, 40, 0.8)';
            
            updateStrategyHint();
        }
        
        function clearBet() {
            if (gameState !== 'waiting') return;
            
            currentBet = 0;
            document.getElementById('currentBet').textContent = '$0';
            
            document.querySelectorAll('.chip').forEach(chip => {
                chip.style.transform = 'scale(1)';
                chip.style.boxShadow = '';
            });
            
            updateStrategyHint();
        }
        
        async function startNewHand() {
            if (gameState !== 'waiting' || currentBet === 0) {
                if (currentBet === 0) {
                    showNotification('Please place a bet first!', 'error');
                }
                return;
            }
            
            const currentBalance = parseInt((document.getElementById('balanceDisplay').textContent || '0').replace(/[^0-9]/g, '')) || 0;
            if (currentBalance < currentBet) {
                showNotification('Insufficient balance!', 'error');
                return;
            }
            
            // Reset game state
            gameState = 'playing';
            playerHand = [];
            dealerHand = [];
            
            // Clear cards display
            document.getElementById('playerCards').innerHTML = '';
            document.getElementById('dealerCards').innerHTML = '';
            
            // Update UI
            updateGameStatus('Dealing cards...');
            updateActionButtons();
            
            try {
                const response = await fetch('/api/blackjack/deal', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        Game: 'Vegas Blackjack',
                        BetAmount: currentBet,
                        Username: localStorage.getItem('vegas.username') || localStorage.getItem('vegasUser') || 'Anonymous',
                        WinFlag: null,
                        WinningAmount: 0,
                        LossAmount: 0,
                        Balance: parseInt(localStorage.getItem('vegasBalance') || '0'),
                        Timestamp: new Date().toISOString(),
                        Action: 'Deal',
                        Device: 'Browser-UI',
                        CorrelationId: `sim_${Date.now()}_${Math.floor(Math.random()*1e9)}`,
                        ResultIcons: [],
                        Status: 'Started',
                        ErrorType: null,
                        ErrorMessage: null,
                        StatusCode: 0
                    })
                });
                
                const data = await response.json();
                // Deduct stake visually on deal (server debits too)
                const preDealBalance = parseInt((document.getElementById('balanceDisplay').textContent || '0').replace(/[^0-9]/g, '')) || 0;
                document.getElementById('balanceDisplay').textContent = `$${Math.max(0, preDealBalance - currentBet)}`;
                
                // Deal cards with animation
                await dealInitialCards(data.playerHand, data.dealerHand);
                // After deal animation completes, apply server balance if provided
                if (typeof data.newBalance === 'number') {
                    localStorage.setItem('vegasBalance', String(data.newBalance));
                    document.getElementById('balanceDisplay').textContent = `$${data.newBalance}`;
                }
                
                // Update scores
                updateScores(data.playerScore, data.dealerScore);
                
                // Check for blackjack
                if (data.playerScore === 21) {
                    gameState = 'finished';
                    if (data.dealerScore === 21) {
                        handleGameEnd('push', 'Both blackjack! Push.');
                    } else {
                        handleGameEnd('blackjack', 'Blackjack! You win!', currentBet * 2.5);
                    }
                } else {
                    updateGameStatus('Your turn. Hit or stand?');
                    updateActionButtons();
                    updateStrategyHint();
                }
                
            } catch (error) {
                console.error('Deal error:', error);
                showNotification('Deal failed! Try again.', 'error');
                gameState = 'waiting';
                updateActionButtons();
            }
        }
        
        async function dealInitialCards(playerCards, dealerCards) {
            playerHand = playerCards;
            dealerHand = dealerCards;
            
            // Deal player cards
            for (let i = 0; i < playerCards.length; i++) {
                await new Promise(resolve => setTimeout(resolve, 500));
                addCardToHand('player', playerCards[i]);
            }
            
            // Deal dealer cards (second card face down)
            for (let i = 0; i < dealerCards.length; i++) {
                await new Promise(resolve => setTimeout(resolve, 500));
                if (i === 1) {
                    addCardToHand('dealer', { suit: 'hidden', rank: 'hidden' }, true);
                } else {
                    addCardToHand('dealer', dealerCards[i]);
                }
            }
        }
        
        function addCardToHand(player, card, faceDown = false) {
            const container = document.getElementById(`${player}Cards`);
            const cardElement = createCardElement(card, faceDown);
            
            cardElement.classList.add('dealing');
            container.appendChild(cardElement);
            
            // Update deck stats
            if (!faceDown && card.rank !== 'hidden') {
                updateDeckStats(card);
            }
        }
        
        function createCardElement(card, faceDown = false) {
            const cardDiv = document.createElement('div');
            cardDiv.className = 'card';
            
            if (faceDown || card.rank === 'hidden') {
                cardDiv.className += ' card-back';
                cardDiv.innerHTML = '🃏';
                return cardDiv;
            }
            
            const isRed = card.suit === '♥' || card.suit === '♦';
            cardDiv.className += isRed ? ' red' : ' black';
            
            const displayRank = card.rank === 1 ? 'A' : 
                               card.rank === 11 ? 'J' :
                               card.rank === 12 ? 'Q' :
                               card.rank === 13 ? 'K' : card.rank;
            
            cardDiv.innerHTML = `
                <div class="text-left">
                    <div>${displayRank}</div>
                    <div style="font-size: 16px;">${card.suit}</div>
                </div>
                <div class="text-center" style="font-size: 20px;">${card.suit}</div>
                <div class="text-right" style="transform: rotate(180deg);">
                    <div>${displayRank}</div>
                    <div style="font-size: 16px;">${card.suit}</div>
                </div>
            `;
            
            return cardDiv;
        }
        
        async function playerHit() {
            if (gameState !== 'playing') return;
            
            try {
                const response = await fetch('/api/blackjack/hit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        Game: 'Vegas Blackjack',
                        Username: localStorage.getItem('vegas.username') || localStorage.getItem('vegasUser') || 'Anonymous',
                        Timestamp: new Date().toISOString(),
                        Action: 'Hit',
                        Device: 'Browser-UI',
                        CorrelationId: `sim_${Date.now()}_${Math.floor(Math.random()*1e9)}`
                    })
                });
                
                const data = await response.json();
                
                // Add new card
                addCardToHand('player', data.newCard);
                playerHand.push(data.newCard);
                
                // Update score
                updateScores(data.playerScore, data.dealerScore);
                
                if (data.playerScore > 21) {
                    gameState = 'finished';
                    handleGameEnd('bust', 'Bust! You lose.');
                } else if (data.playerScore === 21) {
                    // Auto-stand on 21
                    playerStand();
                } else {
                    updateGameStatus('Hit or stand?');
                    updateStrategyHint();
                }
                
                updateActionButtons();
                
            } catch (error) {
                console.error('Hit error:', error);
                showNotification('Hit failed! Try again.', 'error');
            }
        }
        
        async function playerStand() {
            if (gameState !== 'playing') return;
            
            gameState = 'dealer_turn';
            updateGameStatus('Dealer\'s turn...');
            updateActionButtons();
            
            // Reveal dealer's hidden card
            await revealDealerCard();
            
            try {
                const response = await fetch('/api/blackjack/stand', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        Game: 'Vegas Blackjack',
                        Username: localStorage.getItem('vegas.username') || localStorage.getItem('vegasUser') || 'Anonymous',
                        Timestamp: new Date().toISOString(),
                        Action: 'Stand',
                        Device: 'Browser-UI',
                        CorrelationId: `sim_${Date.now()}_${Math.floor(Math.random()*1e9)}`
                    })
                });
                
                const data = await response.json();
                
                // Play dealer's hand
                await playDealerHand(data.dealerFinalHand, data.dealerScore);
                
                // Determine winner
                gameState = 'finished';
                if (data.result === 'win') {
                    handleGameEnd('win', 'You win!', data.payout);
                } else if (data.result === 'push') {
                    handleGameEnd('push', 'Push! Tie game.', currentBet);
                } else {
                    handleGameEnd('lose', 'Dealer wins.');
                }
                if (typeof data.newBalance === 'number') {
                    localStorage.setItem('vegasBalance', String(data.newBalance));
                    document.getElementById('balanceDisplay').textContent = `$${data.newBalance}`;
                }
                // Emit Completed BizEvent
                try {
                    const username = localStorage.getItem('vegas.username') || localStorage.getItem('vegasUser') || 'Anonymous';
                    const completedEvent = {
                        Game: 'Vegas Blackjack',
                        BetAmount: currentBet,
                        Username: username,
                        WinFlag: data.result === 'win' || data.result === 'blackjack' ? 1 : 0,
                        WinningAmount: data.payout || 0,
                        LossAmount: (data.result === 'win' || data.result === 'blackjack') ? 0 : (data.result === 'push' ? 0 : currentBet),
                        Balance: parseInt((document.getElementById('balanceDisplay').textContent || '0').replace(/[^0-9]/g,'')) || 0,
                        Timestamp: new Date().toISOString(),
                        Action: 'HandCompleted',
                        Device: 'Browser-UI',
                        CorrelationId: data.correlationId || `sim_${Date.now()}`,
                        ResultIcons: [],
                        Status: 'Completed',
                        ErrorType: null,
                        ErrorMessage: null,
                        StatusCode: 200
                    };
                    fetch('/api/bizevent', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(completedEvent) });
                } catch {}
                
            } catch (error) {
                console.error('Stand error:', error);
                showNotification('Stand failed! Try again.', 'error');
            }
        }
        
        async function playerDouble() {
            if (gameState !== 'playing' || playerHand.length !== 2) return;
            
            const currentBalance = parseInt((document.getElementById('balanceDisplay').textContent || '0').replace(/[^0-9]/g, '')) || 0;
            if (currentBalance < currentBet) {
                showNotification('Insufficient balance to double!', 'error');
                return;
            }
            
            currentBet *= 2;
            document.getElementById('currentBet').textContent = `$${currentBet}`;
            
            try {
                const response = await fetch('/api/blackjack/double', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        Game: 'Vegas Blackjack',
                        Username: localStorage.getItem('vegas.username') || localStorage.getItem('vegasUser') || 'Anonymous',
                        Timestamp: new Date().toISOString(),
                        Action: 'Double',
                        Device: 'Browser-UI',
                        CorrelationId: `sim_${Date.now()}_${Math.floor(Math.random()*1e9)}`
                    })
                });
                
                const data = await response.json();
                if (typeof data.newBalance === 'number') {
                    localStorage.setItem('vegasBalance', String(data.newBalance));
                    document.getElementById('balanceDisplay').textContent = `$${data.newBalance}`;
                }
                
                // Add one card and auto-stand
                addCardToHand('player', data.newCard);
                playerHand.push(data.newCard);
                
                updateScores(data.playerScore, data.dealerScore);
                
                if (data.playerScore > 21) {
                    gameState = 'finished';
                    handleGameEnd('bust', 'Bust! You lose.');
                } else {
                    // Auto-stand after double
                    playerStand();
                }
                
            } catch (error) {
                console.error('Double error:', error);
                showNotification('Double failed! Try again.', 'error');
                // Server did not accept double; keep current bet display as-is
            }
        }
        
        async function revealDealerCard() {
            const dealerCards = document.getElementById('dealerCards');
            const hiddenCard = dealerCards.querySelector('.card-back');
            
            if (hiddenCard && dealerHand.length > 1) {
                hiddenCard.classList.add('flipping');
                
                setTimeout(() => {
                    const newCard = createCardElement(dealerHand[1]);
                    hiddenCard.replaceWith(newCard);
                    updateDeckStats(dealerHand[1]);
                }, 300);
            }
        }
        
        async function playDealerHand(finalHand, finalScore) {
            // Add any additional cards the dealer drew
            for (let i = 2; i < finalHand.length; i++) {
                await new Promise(resolve => setTimeout(resolve, 1000));
                addCardToHand('dealer', finalHand[i]);
            }
            
            dealerHand = finalHand;
            updateScores(null, finalScore);
        }
        
        function updateScores(playerScore, dealerScore) {
            if (playerScore !== null) {
                document.getElementById('playerScore').textContent = playerScore;
                const playerDisplay = document.getElementById('playerScoreDisplay');
                playerDisplay.classList.remove('bust', 'blackjack');
                
                if (playerScore > 21) {
                    playerDisplay.classList.add('bust');
                } else if (playerScore === 21 && playerHand.length === 2) {
                    playerDisplay.classList.add('blackjack');
                }
            }
            
            if (dealerScore !== null && gameState !== 'playing') {
                document.getElementById('dealerScore').textContent = dealerScore;
                const dealerDisplay = document.getElementById('dealerScoreDisplay');
                dealerDisplay.classList.remove('bust', 'blackjack');
                
                if (dealerScore > 21) {
                    dealerDisplay.classList.add('bust');
                } else if (dealerScore === 21 && dealerHand.length === 2) {
                    dealerDisplay.classList.add('blackjack');
                }
            }
        }
        
        function handleGameEnd(result, message, payout = 0) {
            updateGameStatus(message);
            
            if (payout > 0) {
                // Show payout animation
                const payoutText = document.createElement('div');
                payoutText.className = 'fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-6xl font-bold text-dt-yellow z-50 animate-bounce';
                payoutText.textContent = `+$${payout}`;
                document.body.appendChild(payoutText);
                
                setTimeout(() => {
                    payoutText.remove();
                }, 2000);
            }
            
            // Update stats
            updateGameStats(result, payout);
            
            // Emit game action
            socket.emit('game-action', {
                game: 'blackjack',
                action: 'hand_complete',
                betAmount: currentBet,
                result: result,
                win: payout > 0,
                winAmount: payout
            });
            
            // Reset for next hand
            setTimeout(() => {
                gameState = 'waiting';
                currentBet = 0;
                document.getElementById('currentBet').textContent = '$0';
                updateActionButtons();
                updateGameStatus('Place your bet for the next hand.');
                
                // Clear chip selection
                document.querySelectorAll('.chip').forEach(chip => {
                    chip.style.transform = 'scale(1)';
                    chip.style.boxShadow = '';
                });
            }, 3000);
        }
        
        function updateGameStats(result, payout) {
            gameStats.totalHands++;
            
            if (result === 'win' || result === 'blackjack') {
                gameStats.totalWins++;
            }
            
            if (result === 'blackjack') {
                gameStats.totalBlackjacks++;
            }
            
            if (result === 'push') {
                gameStats.totalPushes++;
            }
            
            gameStats.netProfit += (payout - currentBet);
            
            // Add to recent hands
            gameStats.recentHands.unshift({
                result: result,
                bet: currentBet,
                payout: payout,
                profit: payout - currentBet,
                timestamp: Date.now()
            });
            
            // Keep only last 10 hands
            if (gameStats.recentHands.length > 10) {
                gameStats.recentHands = gameStats.recentHands.slice(0, 10);
            }
            
            updateStatsDisplay();
        }
        
        function updateStatsDisplay() {
            document.getElementById('totalHands').textContent = gameStats.totalHands;
            document.getElementById('totalWins').textContent = gameStats.totalWins;
            document.getElementById('totalBlackjacks').textContent = gameStats.totalBlackjacks;
            
            const winRate = gameStats.totalHands > 0 ? 
                ((gameStats.totalWins / gameStats.totalHands) * 100).toFixed(1) : 0;
            document.getElementById('winRate').textContent = `${winRate}%`;
            
            const profitElement = document.getElementById('netProfit');
            profitElement.textContent = `$${gameStats.netProfit}`;
            profitElement.className = gameStats.netProfit >= 0 ? 'font-mono text-dt-green' : 'font-mono text-red-400';
            
            updateRecentHandsDisplay();
        }
        
        function updateRecentHandsDisplay() {
            const container = document.getElementById('recentHands');
            container.innerHTML = '';
            
            if (gameStats.recentHands.length === 0) {
                container.innerHTML = '<div class="text-dt-light-gray text-center">No hands played yet</div>';
                return;
            }
            
            gameStats.recentHands.forEach(hand => {
                const handDiv = document.createElement('div');
                handDiv.className = 'flex justify-between items-center p-2 bg-dt-darker rounded border border-dt-gray/30';
                
                let resultColor = 'text-dt-light-gray';
                let resultText = hand.result;
                
                if (hand.result === 'win' || hand.result === 'blackjack') {
                    resultColor = 'text-dt-green';
                    resultText = hand.result === 'blackjack' ? 'BJ' : 'W';
                } else if (hand.result === 'push') {
                    resultColor = 'text-dt-yellow';
                    resultText = 'P';
                } else {
                    resultColor = 'text-red-400';
                    resultText = 'L';
                }
                
                handDiv.innerHTML = `
                    <div class="flex items-center space-x-2">
                        <div class="text-xs bg-dt-gray px-2 py-1 rounded ${resultColor} font-bold">
                            ${resultText}
                        </div>
                        <div class="text-xs text-dt-light-gray">$${hand.bet}</div>
                    </div>
                    <div class="text-right text-xs">
                        <div class="${hand.profit >= 0 ? 'text-dt-green' : 'text-red-400'}">
                            ${hand.profit >= 0 ? '+' : ''}$${hand.profit}
                        </div>
                    </div>
                `;
                container.appendChild(handDiv);
            });
        }
        
        function updateDeckStats(card) {
            deckStats.cardsDealt++;
            
            // Update high/low card counts for basic card counting
            if (card.rank >= 10 || card.rank === 1) {
                deckStats.highCards--;
                deckStats.runningCount--;
            } else if (card.rank >= 2 && card.rank <= 6) {
                deckStats.lowCards--;
                deckStats.runningCount++;
            }
            
            document.getElementById('cardsDealt').textContent = `${deckStats.cardsDealt}/52`;
            document.getElementById('highCards').textContent = Math.max(0, deckStats.highCards);
            document.getElementById('lowCards').textContent = Math.max(0, deckStats.lowCards);
            document.getElementById('runningCount').textContent = deckStats.runningCount > 0 ? `+${deckStats.runningCount}` : deckStats.runningCount;
            
            const penetration = (deckStats.cardsDealt / 52) * 100;
            document.getElementById('deckPenetration').style.width = `${penetration}%`;
        }
        
        function updateActionButtons() {
            const dealButton = document.getElementById('dealButton');
            const hitButton = document.getElementById('hitButton');
            const standButton = document.getElementById('standButton');
            const doubleButton = document.getElementById('doubleButton');
            
            // Reset all buttons
            [dealButton, hitButton, standButton, doubleButton].forEach(btn => {
                btn.disabled = true;
            });
            
            switch (gameState) {
                case 'waiting':
                    dealButton.disabled = currentBet > 0;
                    dealButton.textContent = currentBet > 0 ? 'Deal Cards' : 'Place Bet First';
                    break;
                    
                case 'playing':
                    hitButton.disabled = false;
                    standButton.disabled = false;
                    doubleButton.disabled = playerHand.length !== 2 || 
                        parseInt(localStorage.getItem('vegasBalance') || '0') < currentBet;
                    break;
                    
                case 'dealer_turn':
                case 'finished':
                    // All buttons disabled
                    break;
            }
        }
        
        function updateGameStatus(message) {
            document.getElementById('gameStatus').innerHTML = `
                <span class="text-dt-cyan">${message}</span>
            `;
        }
        
        function updateStrategyHint() {
            const hintElement = document.getElementById('strategyHint');
            
            if (gameState === 'waiting') {
                hintElement.textContent = currentBet > 0 ? 
                    'Ready to deal! Click "Deal Cards" to start.' :
                    'Place a bet to receive AI-powered strategy recommendations.';
                return;
            }
            
            if (gameState !== 'playing' || playerHand.length === 0) {
                hintElement.textContent = 'Game in progress...';
                return;
            }
            
            const playerScore = calculateScore(playerHand);
            const dealerUpCard = dealerHand[0];
            const dealerValue = dealerUpCard.rank === 1 ? 11 : Math.min(dealerUpCard.rank, 10);
            
            let hint = '';
            
            // Basic strategy recommendations
            if (playerScore < 12) {
                hint = '📈 Always HIT with score under 12';
            } else if (playerScore >= 17) {
                hint = '🛑 Always STAND with score 17 or higher';
            } else if (playerScore === 16) {
                hint = dealerValue >= 7 ? '⚡ HIT vs dealer 7-A' : '🛑 STAND vs dealer 2-6';
            } else if (playerScore === 15) {
                hint = dealerValue >= 7 ? '⚡ HIT vs dealer 7-A' : '🛑 STAND vs dealer 2-6';
            } else if (playerScore >= 13 && playerScore <= 14) {
                hint = dealerValue >= 7 ? '⚡ HIT vs dealer 7-A' : '🛑 STAND vs dealer 2-6';
            } else if (playerScore === 12) {
                hint = (dealerValue >= 4 && dealerValue <= 6) ? '🛑 STAND vs dealer 4-6' : '⚡ HIT vs other cards';
            }
            
            // Double down recommendations
            if (playerHand.length === 2) {
                if (playerScore === 11) {
                    hint = '💎 DOUBLE DOWN with 11 (if possible)';
                } else if (playerScore === 10 && dealerValue < 10) {
                    hint = '💎 Consider DOUBLE DOWN with 10 vs dealer 2-9';
                } else if (playerScore === 9 && dealerValue >= 3 && dealerValue <= 6) {
                    hint = '💎 Consider DOUBLE DOWN with 9 vs dealer 3-6';
                }
            }
            
            hintElement.textContent = hint || 'Analyze the situation carefully...';
        }
        
        function calculateScore(hand) {
            let score = 0;
            let aces = 0;
            
            for (let card of hand) {
                if (card.rank === 1) {
                    aces++;
                    score += 11;
                } else {
                    score += Math.min(card.rank, 10);
                }
            }
            
            while (score > 21 && aces > 0) {
                score -= 10;
                aces--;
            }
            
            return score;
        }
        
        async function addFunds() {
            const username = localStorage.getItem('vegas.username') || localStorage.getItem('vegasUser') || 'Anonymous';
            try {
                const resp = await fetch('/api/user/topup', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ Username: username, Amount: 500 })
                });
                const data = await resp.json();
                if (typeof data.balance === 'number') {
                    localStorage.setItem('vegasBalance', String(data.balance));
                    updateBalanceDisplay();
                    showNotification('💰 $500 added to your balance!', 'success');
                } else {
                    showNotification('Top-up failed to persist.', 'error');
                }
            } catch (e) {
                showNotification('Top-up request failed.', 'error');
            }
        }
        
        function updateBalance(change) {
            const currentBalance = parseInt(localStorage.getItem('vegasBalance') || '0');
            const newBalance = Math.max(0, currentBalance + change);
            localStorage.setItem('vegasBalance', newBalance);
            updateBalanceDisplay();
        }
        
        function updateBalanceDisplay() {
            const balance = localStorage.getItem('vegasBalance') || '0';
            document.getElementById('balanceDisplay').textContent = `$${balance}`;
        }
        
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `fixed top-6 right-6 z-50 p-4 rounded-lg shadow-lg ${
                type === 'success' ? 'bg-dt-green text-white' : 
                type === 'error' ? 'bg-red-500 text-white' : 
                'bg-dt-blue text-white'
            }`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            // Animate in
            gsap.from(notification, {
                duration: 0.3,
                x: 100,
                opacity: 0,
                ease: "back.out(1.7)"
            });
            
            // Auto remove
            setTimeout(() => {
                gsap.to(notification, {
                    duration: 0.3,
                    x: 100,
                    opacity: 0,
                    ease: "back.in(1.7)",
                    onComplete: () => notification.remove()
                });
            }, 3000);
        }
        
        // Initialize page
        document.addEventListener('DOMContentLoaded', async function() {
            const username = localStorage.getItem('vegas.username') || localStorage.getItem('vegasUser') || 'Agent';
            document.getElementById('agentName').textContent = username;
            try {
                const resp = await fetch('/api/user/init', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ Username: username })
                });
                const u = await resp.json();
                if (typeof u.balance === 'number') {
                    localStorage.setItem('vegasBalance', String(u.balance));
                    document.getElementById('balanceDisplay').textContent = `$${u.balance}`;
                } else {
                    updateBalanceDisplay();
                }
            } catch (e) {
                updateBalanceDisplay();
            }
            updateActionButtons();
            updateStrategyHint();
            
            // Animate page entrance
            gsap.from('.blackjack-table', {
                duration: 1,
                scale: 0.9,
                opacity: 0,
                ease: "back.out(1.7)"
            });
            
            gsap.from('.betting-area', {
                duration: 0.8,
                y: 50,
                opacity: 0,
                stagger: 0.2,
                ease: "back.out(1.7)",
                delay: 0.3
            });
        });
        
        // Socket event handlers
        socket.on('connect', () => {
            console.log('🔌 Connected to blackjack game');
        });
    </script>
</body>
</html>