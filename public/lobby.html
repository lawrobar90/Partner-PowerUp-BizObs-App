<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynatrace Vegas Casino - Smartscape Lobby</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Tailwind Config -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'dt-purple': '#6C2C9C',
                        'dt-blue': '#00A1C9',
                        'dt-cyan': '#00D4FF',
                        'dt-green': '#73BE28',
                        'dt-orange': '#FFA86B',
                        'dt-yellow': '#FFD23F',
                        'dt-dark': '#151515',
                        'dt-darker': '#0A0A0A',
                        'dt-gray': '#2D2D2D',
                        'dt-light-gray': '#4A4A4A'
                    }
                }
            }
        }
    </script>
    
    <!-- External libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* Smartscape-inspired styles */
        .smartscape-bg {
            background: 
                radial-gradient(circle at 10% 20%, rgba(108, 44, 156, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 90% 80%, rgba(0, 212, 255, 0.1) 0%, transparent 50%),
                linear-gradient(135deg, #0A0A0A 0%, #151515 100%);
        }
        
        .game-node {
            position: relative;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            cursor: pointer;
            filter: drop-shadow(0 0 20px rgba(0, 212, 255, 0.3));
        }
        
        .game-node::before {
            content: '';
            position: absolute;
            inset: -2px;
            padding: 2px;
            background: linear-gradient(45deg, #00D4FF, #6C2C9C, #73BE28, #FFD23F);
            border-radius: inherit;
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: -1;
        }
        
        .game-node:hover::before {
            opacity: 0.8;
        }
        
        .game-node:hover {
            transform: scale(1.1) translateY(-10px);
            filter: drop-shadow(0 20px 40px rgba(0, 212, 255, 0.4));
        }
        
        .connection-line {
            position: absolute;
            height: 2px;
            background: linear-gradient(90deg, transparent, #00D4FF, transparent);
            opacity: 0.6;
            animation: pulse-line 2s ease-in-out infinite;
        }
        
        @keyframes pulse-line {
            0%, 100% { opacity: 0.3; transform: scaleX(1); }
            50% { opacity: 0.8; transform: scaleX(1.1); }
        }
        
        .metrics-overlay {
            background: rgba(21, 21, 21, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(0, 212, 255, 0.3);
        }
        
        .pulsing-dot {
            animation: pulse-dot 2s ease-in-out infinite;
        }
        
        @keyframes pulse-dot {
            0%, 100% { opacity: 0.4; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.2); }
        }
        
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            animation: status-blink 1.5s ease-in-out infinite;
        }
        
        @keyframes status-blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
        
        .holographic-text {
            background: linear-gradient(45deg, #00D4FF, #6C2C9C, #00D4FF);
            background-size: 200% 200%;
            animation: holographic 3s ease-in-out infinite;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        @keyframes holographic {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }
    </style>
</head>
<body class="min-h-screen smartscape-bg text-white font-sans overflow-x-hidden">
    
    <!-- Header with user info and metrics -->
    <header class="relative z-50 bg-dt-dark/80 backdrop-blur-md border-b border-dt-cyan/30">
        <div class="max-w-7xl mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                
                <!-- Logo and title -->
                <div class="flex items-center space-x-4">
                    <div class="w-10 h-10 bg-gradient-to-br from-dt-purple to-dt-cyan rounded-lg flex items-center justify-center">
                        <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
                        </svg>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold holographic-text">Dynatrace Vegas</h1>
                        <p class="text-xs text-dt-light-gray">Smartscape Lobby</p>
                    </div>
                </div>
                
                <!-- User info and balance -->
                <div class="flex items-center space-x-6">
                    <div class="metrics-overlay rounded-lg px-4 py-2">
                        <div class="flex items-center space-x-4 text-sm">
                            <div class="flex items-center space-x-2">
                                <div class="status-indicator bg-dt-green"></div>
                                <span class="text-dt-cyan">Agent:</span>
                                <span id="agentName" class="font-mono text-white">Loading...</span>
                            </div>
                            <div class="flex items-center space-x-2">
                                <span class="text-dt-cyan">Balance:</span>
                                <span id="balanceDisplay" class="font-mono text-dt-yellow font-semibold">$0</span>
                            </div>
                            <button onclick="addFunds()" class="bg-dt-green hover:bg-dt-green/80 text-white px-3 py-1 rounded text-xs font-semibold transition-colors">
                                Top Up
                            </button>
                        </div>
                    </div>
                    
                    <!-- Navigation buttons -->
                    <div class="flex items-center space-x-2">
                        <button onclick="showLeaderboard()" class="bg-dt-purple hover:bg-dt-purple/80 text-white px-4 py-2 rounded-lg text-sm font-semibold transition-colors flex items-center space-x-2">
                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            <span>Leaderboard</span>
                        </button>
                        <button onclick="window.location.href='index.html'" class="bg-dt-gray hover:bg-dt-light-gray text-white px-4 py-2 rounded-lg text-sm font-semibold transition-colors">
                            Exit Vault
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </header>
    
    <!-- Main Smartscape Map -->
    <main class="relative min-h-screen pt-8 overflow-y-auto">
        
        <!-- Real-time metrics overlay -->
        <div class="fixed top-24 right-6 z-40 metrics-overlay rounded-xl p-4 w-64">
            <h3 class="text-dt-cyan font-semibold mb-3 flex items-center">
                <div class="pulsing-dot w-2 h-2 bg-dt-green rounded-full mr-2"></div>
                Live Metrics
            </h3>
            <div class="space-y-2 text-sm">
                <div class="flex justify-between">
                    <span class="text-dt-light-gray">Active Users:</span>
                    <span id="activeUsers" class="text-dt-cyan font-mono">0</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-dt-light-gray">Total Spins:</span>
                    <span id="totalSpins" class="text-dt-cyan font-mono">0</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-dt-light-gray">Win Rate:</span>
                    <span id="winRate" class="text-dt-yellow font-mono">0%</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-dt-light-gray">System Health:</span>
                    <span class="flex items-center space-x-1">
                        <div class="status-indicator bg-dt-green"></div>
                        <span class="text-dt-green font-mono">Optimal</span>
                    </span>
                </div>
            </div>
        </div>
        
        <!-- Smartscape Game Map -->
        <div class="relative max-w-6xl mx-auto px-6 py-12">
            
            <!-- Connection lines between games -->
            <div class="absolute inset-0">
                <!-- Horizontal lines -->
                <div class="connection-line" style="top: 30%; left: 25%; width: 25%; transform: rotate(15deg);"></div>
                <div class="connection-line" style="top: 30%; right: 25%; width: 25%; transform: rotate(-15deg);"></div>
                <div class="connection-line" style="bottom: 30%; left: 25%; width: 25%; transform: rotate(-15deg);"></div>
                <div class="connection-line" style="bottom: 30%; right: 25%; width: 25%; transform: rotate(15deg);"></div>
                
                <!-- Vertical lines -->
                <div class="connection-line" style="top: 40%; left: 50%; height: 20%; width: 2px; transform: translateX(-50%);"></div>
                <div class="connection-line" style="top: 20%; left: 35%; height: 15%; width: 2px; transform: rotate(45deg);"></div>
                <div class="connection-line" style="top: 20%; right: 35%; height: 15%; width: 2px; transform: rotate(-45deg);"></div>
            </div>
            
            <!-- Game nodes arranged in Smartscape style -->
            <div class="relative grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 lg:gap-12">
                
                <!-- Slots Game Node -->
                <div class="game-node" onclick="navigateToGame('slots')">
                    <div class="bg-gradient-to-br from-dt-purple/20 to-dt-blue/20 rounded-2xl p-6 border border-dt-cyan/30 backdrop-blur-sm">
                        <div class="text-center">
                            <div class="w-20 h-20 mx-auto bg-gradient-to-br from-dt-purple to-dt-blue rounded-xl flex items-center justify-center mb-4 shadow-lg overflow-hidden">
                                <img src="/assets/slot-icons/dynatrace.png" alt="Slots" class="w-12 h-12 object-contain" onerror="this.style.display='none'; this.parentElement.innerHTML='<div class=\'text-3xl\'>üé∞</div>'">
                            </div>
                            <h3 class="text-xl font-bold text-dt-cyan mb-2">Quantum Slots</h3>
                            <p class="text-dt-light-gray text-sm mb-4">Advanced probability matrices</p>
                            <div class="flex justify-between text-xs text-dt-light-gray">
                                <span>RTP: 96.5%</span>
                                <span class="text-dt-green">Online</span>
                            </div>
                            <div class="mt-2 flex justify-center">
                                <div class="flex space-x-1">
                                    <div class="pulsing-dot w-1 h-1 bg-dt-cyan rounded-full"></div>
                                    <div class="pulsing-dot w-1 h-1 bg-dt-purple rounded-full" style="animation-delay: 0.2s;"></div>
                                    <div class="pulsing-dot w-1 h-1 bg-dt-green rounded-full" style="animation-delay: 0.4s;"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Roulette Game Node -->
                <div class="game-node" onclick="navigateToGame('roulette')">
                    <div class="bg-gradient-to-br from-dt-green/20 to-dt-yellow/20 rounded-2xl p-6 border border-dt-green/30 backdrop-blur-sm">
                        <div class="text-center">
                            <div class="w-20 h-20 mx-auto bg-gradient-to-br from-dt-green to-dt-yellow rounded-full flex items-center justify-center mb-4 shadow-lg overflow-hidden">
                                <img src="/assets/roulette/roulette.png" alt="Roulette" class="w-12 h-12 object-contain" onerror="this.style.display='none'; this.parentElement.innerHTML='<div class=\'text-3xl\'>üé°</div>'">
                            </div>
                            <h3 class="text-xl font-bold text-dt-green mb-2">Cosmic Roulette</h3>
                            <p class="text-dt-light-gray text-sm mb-4">Orbital betting mechanics</p>
                            <div class="flex justify-between text-xs text-dt-light-gray">
                                <span>House Edge: 2.7%</span>
                                <span class="text-dt-green">Online</span>
                            </div>
                            <div class="mt-2 flex justify-center">
                                <div class="flex space-x-1">
                                    <div class="pulsing-dot w-1 h-1 bg-dt-green rounded-full"></div>
                                    <div class="pulsing-dot w-1 h-1 bg-dt-yellow rounded-full" style="animation-delay: 0.3s;"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Dice Game Node -->
                <div class="game-node" onclick="navigateToGame('dice')">
                    <div class="bg-gradient-to-br from-dt-orange/20 to-dt-yellow/20 rounded-2xl p-6 border border-dt-orange/30 backdrop-blur-sm">
                        <div class="text-center">
                            <div class="w-20 h-20 mx-auto bg-gradient-to-br from-dt-orange to-dt-yellow rounded-lg flex items-center justify-center mb-4 shadow-lg overflow-hidden">
                                <img src="/assets/dice/dice.png" alt="Dice" class="w-12 h-12 object-contain" onerror="this.style.display='none'; this.parentElement.innerHTML='<div class=\'text-3xl\'>üé≤</div>'">
                            </div>
                            <h3 class="text-xl font-bold text-dt-orange mb-2">Neural Dice</h3>
                            <p class="text-dt-light-gray text-sm mb-4">Probability prediction engine</p>
                            <div class="flex justify-between text-xs text-dt-light-gray">
                                <span>Max Payout: 30:1</span>
                                <span class="text-dt-green">Online</span>
                            </div>
                            <div class="mt-2 flex justify-center">
                                <div class="flex space-x-1">
                                    <div class="pulsing-dot w-1 h-1 bg-dt-orange rounded-full"></div>
                                    <div class="pulsing-dot w-1 h-1 bg-dt-yellow rounded-full" style="animation-delay: 0.4s;"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Blackjack Game Node -->
                <div class="game-node" onclick="navigateToGame('blackjack')">
                    <div class="bg-gradient-to-br from-dt-blue/20 to-dt-cyan/20 rounded-2xl p-6 border border-dt-blue/30 backdrop-blur-sm">
                        <div class="text-center">
                            <div class="w-20 h-20 mx-auto bg-gradient-to-br from-dt-blue to-dt-cyan rounded-lg flex items-center justify-center mb-4 shadow-lg overflow-hidden">
                                <img src="/assets/blackjack/blackjack.png" alt="Blackjack" class="w-12 h-12 object-contain" onerror="this.style.display='none'; this.parentElement.innerHTML='<div class=\'text-3xl\'>üÉè</div>'">
                            </div>
                            <h3 class="text-xl font-bold text-dt-blue mb-2">Quantum Blackjack</h3>
                            <p class="text-dt-light-gray text-sm mb-4">AI-enhanced card analysis</p>
                            <div class="flex justify-between text-xs text-dt-light-gray">
                                <span>Basic Strategy: 99.5%</span>
                                <span class="text-dt-green">Online</span>
                            </div>
                            <div class="mt-2 flex justify-center">
                                <div class="flex space-x-1">
                                    <div class="pulsing-dot w-1 h-1 bg-dt-blue rounded-full"></div>
                                    <div class="pulsing-dot w-1 h-1 bg-dt-cyan rounded-full" style="animation-delay: 0.1s;"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Analytics Dashboard Node -->
                <div class="game-node" onclick="showAnalytics()">
                    <div class="bg-gradient-to-br from-dt-gray/40 to-dt-light-gray/40 rounded-2xl p-6 border border-dt-light-gray/30 backdrop-blur-sm">
                        <div class="text-center">
                            <div class="w-20 h-20 mx-auto bg-gradient-to-br from-dt-gray to-dt-light-gray rounded-lg flex items-center justify-center mb-4 shadow-lg">
                                <svg class="w-10 h-10 text-white" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M3 3v18h18M9 17V9m4 8V5m4 12v-4"/>
                                </svg>
                            </div>
                            <h3 class="text-xl font-bold text-dt-light-gray mb-2">Analytics Hub</h3>
                            <p class="text-dt-light-gray text-sm mb-4">Performance insights</p>
                            <div class="flex justify-between text-xs text-dt-light-gray">
                                <span>Real-time data</span>
                                <span class="text-dt-green">Active</span>
                            </div>
                            <div class="mt-2 flex justify-center">
                                <div class="flex space-x-1">
                                    <div class="pulsing-dot w-1 h-1 bg-dt-light-gray rounded-full"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Settings/Profile Node -->
                <div class="game-node" onclick="showProfile()">
                    <div class="bg-gradient-to-br from-dt-purple/20 to-dt-cyan/20 rounded-2xl p-6 border border-dt-purple/30 backdrop-blur-sm">
                        <div class="text-center">
                            <div class="w-20 h-20 mx-auto bg-gradient-to-br from-dt-purple to-dt-cyan rounded-full flex items-center justify-center mb-4 shadow-lg">
                                <svg class="w-10 h-10 text-white" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M12 2C13.1 2 14 2.9 14 4C14 5.1 13.1 6 12 6C10.9 6 10 5.1 10 4C10 2.9 10.9 2 12 2ZM21 9V7L15 7.5V9M15 11.5V9H21V11.5M7 22C5.9 22 5 21.1 5 20S5.9 18 7 18 9 18.9 9 20 8.1 22 7 22M17 22C15.9 22 15 21.1 15 20S15.9 18 17 18 19 18.9 19 20 18.1 22 17 22Z"/>
                                </svg>
                            </div>
                            <h3 class="text-xl font-bold text-dt-purple mb-2">Agent Profile</h3>
                            <p class="text-dt-light-gray text-sm mb-4">Security & preferences</p>
                            <div class="flex justify-between text-xs text-dt-light-gray">
                                <span id="securityLevel">Standard</span>
                                <span class="text-dt-green">Verified</span>
                            </div>
                            <div class="mt-2 flex justify-center">
                                <div class="flex space-x-1">
                                    <div class="pulsing-dot w-1 h-1 bg-dt-purple rounded-full"></div>
                                    <div class="pulsing-dot w-1 h-1 bg-dt-cyan rounded-full" style="animation-delay: 0.2s;"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
            </div>
        </div>
        
        <!-- Quick actions floating bar -->
        <div class="fixed bottom-6 left-1/2 transform -translate-x-1/2 z-40">
            <div class="metrics-overlay rounded-full px-6 py-3 flex items-center space-x-4">
                <button onclick="quickSpin()" class="flex items-center space-x-2 bg-dt-purple hover:bg-dt-purple/80 text-white px-4 py-2 rounded-full text-sm font-semibold transition-colors">
                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd"/>
                    </svg>
                    <span>Quick Spin</span>
                </button>
                <div class="w-px h-6 bg-dt-light-gray"></div>
                <span class="text-sm text-dt-light-gray">System Status:</span>
                <div class="flex items-center space-x-1">
                    <div class="status-indicator bg-dt-green"></div>
                    <span class="text-dt-green text-sm font-mono">Operational</span>
                </div>
            </div>
        </div>
    </main>

    <script>
        // Initialize Socket.IO connection
        const socket = io();
        
        // Game navigation with smooth transitions
        function navigateToGame(gameType) {
            // Show loading animation
            const gameNode = (typeof event !== 'undefined' && event && event.currentTarget) || null;
            gsap.to(gameNode, {
                duration: 0.3,
                scale: 0.9,
                opacity: 0.8,
                yoyo: true,
                repeat: 1,
                ease: "power2.inOut",
                onComplete: () => {
                    // Navigate to game page
                    const gameUrls = {
                        'slots': 'slots.html',
                        'roulette': 'roulette.html',
                        'dice': 'dice.html',
                        'blackjack': 'blackjack.html'
                    };
                    window.location.href = gameUrls[gameType];
                }
            });
        }
        
        // Quick spin function
        async function quickSpin() {
            // Trigger a quick slots spin and show result in popup
            const username = localStorage.getItem('vegas.username') || localStorage.getItem('vegasUser') || 'Anonymous';
            try {
                const bet = 5;
                const corrId = `sim_${Date.now()}_${Math.floor(Math.random()*1e9)}`;
                const resp = await fetch('/api/slots/spin', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        Game: 'Vegas Slots Machine',
                        BetAmount: bet,
                        Username: username,
                        WinFlag: null,
                        WinningAmount: 0,
                        LossAmount: 0,
                        Balance: parseInt(localStorage.getItem('vegasBalance') || '0'),
                        Timestamp: new Date().toISOString(),
                        Action: 'Spin',
                        Device: 'Browser-UI',
                        CorrelationId: corrId,
                        ResultIcons: [],
                        Status: 'Started',
                        ErrorType: null,
                        ErrorMessage: null,
                        StatusCode: 0
                    })
                });
                const data = await resp.json();
                showQuickSpinResult(data);
                // Prefer server-authoritative balance
                if (typeof data.newBalance === 'number') {
                    localStorage.setItem('vegasBalance', String(data.newBalance));
                    updateBalanceDisplay();
                } else {
                    // Fallback: fetch current balance from server
                    const u = await fetch(`/api/user/balance?username=${encodeURIComponent(username)}`).then(r => r.json());
                    if (typeof u.balance === 'number') {
                        localStorage.setItem('vegasBalance', String(u.balance));
                        updateBalanceDisplay();
                    }
                }
            } catch (error) {
                console.error('Quick spin error:', error);
            }
        }
        
        function showQuickSpinResult(result) {
            // Create and show result popup
            const popup = document.createElement('div');
            popup.className = 'fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center';
            popup.innerHTML = `
                <div class="bg-dt-dark border border-dt-cyan/30 rounded-xl p-6 mx-4 max-w-sm w-full">
                    <h3 class="text-xl font-bold text-dt-cyan text-center mb-4">Quick Spin Result</h3>
                    <div class="flex justify-center space-x-2 mb-4">
                        ${result.result.map(icon => `<div class="w-12 h-12 bg-dt-purple rounded-lg flex items-center justify-center text-2xl">${icon[0].toUpperCase()}</div>`).join('')}
                    </div>
                    <div class="text-center">
                        <p class="text-lg ${result.win ? 'text-dt-green' : 'text-dt-light-gray'} mb-2">
                            ${result.win ? `üéâ Win: $${result.winAmount}` : 'üò¢ No win this time'}
                        </p>
                        <p class="text-sm text-dt-light-gray">Bet: $${result.betAmount}</p>
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" class="w-full mt-4 bg-dt-purple hover:bg-dt-purple/80 text-white py-2 rounded-lg font-semibold transition-colors">
                        Close
                    </button>
                </div>
            `;
            document.body.appendChild(popup);
            
            // Auto-close after 5 seconds
            setTimeout(() => {
                if (popup.parentElement) {
                    popup.remove();
                }
            }, 5000);
        }
        
        // Balance management
        async function addFunds() {
            const username = localStorage.getItem('vegas.username') || localStorage.getItem('vegasUser') || 'Anonymous';
            try {
                const resp = await fetch('/api/user/topup', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ Username: username, Amount: 500 })
                });
                const data = await resp.json();
                if (typeof data.balance === 'number') {
                    localStorage.setItem('vegasBalance', String(data.balance));
                    updateBalanceDisplay();
                    showNotification('üí∞ $500 added to your balance!', 'success');
                } else {
                    showNotification('Top-up failed to persist.', 'error');
                }
            } catch (e) {
                showNotification('Top-up request failed.', 'error');
            }
        }
        
        function updateBalance(change) {
            const currentBalance = parseInt(localStorage.getItem('vegasBalance') || '0');
            const newBalance = Math.max(0, currentBalance + change);
            localStorage.setItem('vegasBalance', newBalance);
            updateBalanceDisplay();
        }
        
        function updateBalanceDisplay() {
            const balance = localStorage.getItem('vegasBalance') || '0';
            document.getElementById('balanceDisplay').textContent = `$${balance}`;
        }
        
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `fixed top-6 right-6 z-50 p-4 rounded-lg shadow-lg ${
                type === 'success' ? 'bg-dt-green text-white' : 
                type === 'error' ? 'bg-red-500 text-white' : 
                'bg-dt-blue text-white'
            }`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            // Animate in
            gsap.from(notification, {
                duration: 0.3,
                x: 100,
                opacity: 0,
                ease: "back.out(1.7)"
            });
            
            // Auto remove
            setTimeout(() => {
                gsap.to(notification, {
                    duration: 0.3,
                    x: 100,
                    opacity: 0,
                    ease: "back.in(1.7)",
                    onComplete: () => notification.remove()
                });
            }, 3000);
        }
        
        // Leaderboard and analytics functions
        function showLeaderboard() {
            window.location.href = 'leaderboard.html';
        }
        
        function showAnalytics() {
            window.location.href = 'analytics.html';
        }
        
        function showProfile() {
            // Show profile modal
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center';
            modal.innerHTML = `
                <div class="bg-dt-dark border border-dt-cyan/30 rounded-xl p-6 mx-4 max-w-md w-full">
                    <h3 class="text-xl font-bold text-dt-cyan text-center mb-4">Agent Profile</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="text-dt-light-gray text-sm">Agent Name:</label>
                            <p class="text-white font-mono">${localStorage.getItem('vegas.username') || localStorage.getItem('vegasUser') || 'Anonymous'}</p>
                        </div>
                        <div>
                            <label class="text-dt-light-gray text-sm">Security Level:</label>
                            <p class="text-dt-cyan font-mono">${localStorage.getItem('securityLevel') || 'Standard'}</p>
                        </div>
                        <div>
                            <label class="text-dt-light-gray text-sm">Current Balance:</label>
                            <p class="text-dt-yellow font-mono">$${localStorage.getItem('vegasBalance') || '0'}</p>
                        </div>
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" class="w-full mt-6 bg-dt-purple hover:bg-dt-purple/80 text-white py-2 rounded-lg font-semibold transition-colors">
                        Close Profile
                    </button>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        // Socket event handlers
        socket.on('connect', () => {
            console.log('üîå Connected to Dynatrace Vegas');
            const username = localStorage.getItem('vegasUser');
            if (username) {
                socket.emit('user-login', { username });
            }
        });
        
        socket.on('metrics-update', (metrics) => {
            // Update real-time metrics display
            document.getElementById('activeUsers').textContent = metrics.activeUsers || 0;
            document.getElementById('totalSpins').textContent = metrics.totalSpins || 0;
            
            const winRate = metrics.totalSpins > 0 ? 
                ((metrics.totalWins / metrics.totalSpins) * 100).toFixed(1) : 0;
            document.getElementById('winRate').textContent = winRate + '%';
        });
        
        // Initialize page
        document.addEventListener('DOMContentLoaded', async function() {
            // Set user info
            const username = localStorage.getItem('vegas.username') || localStorage.getItem('vegasUser') || 'Agent';
            const securityLevel = localStorage.getItem('securityLevel') || 'standard';
            
            document.getElementById('agentName').textContent = username;
            document.getElementById('securityLevel').textContent = securityLevel.charAt(0).toUpperCase() + securityLevel.slice(1);
            // Sync balance from server for authoritative state
            try {
                const resp = await fetch('/api/user/init', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ Username: username })
                });
                const data = await resp.json();
                if (data && typeof data.balance === 'number') {
                    localStorage.setItem('vegasBalance', String(data.balance));
                }
            } catch (e) { /* ignore and show last known */ }
            updateBalanceDisplay();
            
            // Animate page entrance - simplified and guarded to avoid hiding elements
            setTimeout(() => {
                try {
                    gsap.from('.game-node', {
                        duration: 0.8,
                        y: 30,
                        opacity: 0,
                        stagger: 0.1,
                        ease: "back.out(1.7)",
                        delay: 0.1,
                        onComplete: ensureGameNodesVisible
                    });
                } catch (e) {
                    // If animation library hiccups, ensure all tiles are visible
                    ensureGameNodesVisible();
                }
                
                gsap.from('.metrics-overlay', {
                    duration: 0.6,
                    x: 30,
                    opacity: 0,
                    ease: "power3.out",
                    delay: 0.3
                });
            }, 100);

            // Extra safety: force visibility shortly after initial animations
            setTimeout(ensureGameNodesVisible, 1200);
        });

        // Defensive helper to guarantee all tiles are visible (avoids "only first tile visible" issue)
        function ensureGameNodesVisible() {
            document.querySelectorAll('.game-node').forEach(node => {
                node.style.opacity = '1';
                node.style.visibility = 'visible';
                node.style.transform = 'none';
                // Remove gsap inline styles that could linger
                if (node.style.willChange) node.style.willChange = '';
            });
        }
    </script>
</body>
</html>