name: Track Repository Traffic

on:
  schedule:
    # Run daily at 00:00 UTC to collect traffic statistics
    - cron: '0 0 * * *'
  workflow_dispatch: # Allow manual trigger

permissions:
  contents: write

jobs:
  track-traffic:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Fetch traffic statistics
        id: traffic
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Fetching repository traffic statistics..."
          
          # Create directory for traffic data
          mkdir -p .github/traffic-data
          
          # Get current date
          DATE=$(date +%Y-%m-%d)
          
          # Fetch clone statistics
          echo "Fetching clone statistics..."
          CLONES=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/traffic/clones")
          
          # Fetch view statistics
          echo "Fetching view statistics..."
          VIEWS=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/traffic/views")
          
          # Fetch popular paths
          echo "Fetching popular paths..."
          PATHS=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/traffic/popular/paths")
          
          # Fetch referrers
          echo "Fetching referrers..."
          REFERRERS=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/traffic/popular/referrers")
          
          # Save data to files with timestamp
          echo "$CLONES" > ".github/traffic-data/clones-${DATE}.json"
          echo "$VIEWS" > ".github/traffic-data/views-${DATE}.json"
          echo "$PATHS" > ".github/traffic-data/paths-${DATE}.json"
          echo "$REFERRERS" > ".github/traffic-data/referrers-${DATE}.json"
          
          # Create summary file
          cat > ".github/traffic-data/latest-summary.md" << EOF
          # Repository Traffic Summary
          
          **Last Updated**: ${DATE}
          
          ## Clone Statistics
          \`\`\`json
          $CLONES
          \`\`\`
          
          ## View Statistics
          \`\`\`json
          $VIEWS
          \`\`\`
          
          ## Popular Paths
          \`\`\`json
          $PATHS
          \`\`\`
          
          ## Referrers
          \`\`\`json
          $REFERRERS
          \`\`\`
          
          ---
          *Traffic data is collected daily and stored in the `.github/traffic-data` directory.*
          EOF
          
          echo "Traffic data collected successfully!"
          
      - name: Commit traffic data
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          git add .github/traffic-data/
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Update traffic statistics - $(date +%Y-%m-%d)"
            git push
          fi
